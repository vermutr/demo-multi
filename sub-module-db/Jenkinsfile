#!groovy

@Library("multi-demo") _

pipeline {
    environment {
        NEXUS_CREDS = 'nexus-docker'
        NEXUS_DOCKER_REPO = '192.168.92.61:8082/repository/my-test-repo'
    }

    agent any
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Clean') {
            steps {
                gradleTask('sub-module-db:clean')
            }
        }

        stage('Build') {
            steps {
                gradleTask('sub-module-db:assemble')
            }
        }

        stage('Test') {
            steps {
                gradleTask('sub-module-db:test')
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('sub-module-db') {
                    script {
                        buildDockerImage(NEXUS_DOCKER_REPO, 'latest')
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                dir('sub-module-db') {
                    script {
                        pushDockerImage(NEXUS_DOCKER_REPO, 'latest', NEXUS_CREDS)
                    }
                }
            }
        }

        stage('Pull from Nexus') {
            steps {
                dir('sub-module-db') {
                    script {
                        nexusPull(NEXUS_DOCKER_REPO, 'latest', NEXUS_CREDS)
                    }
                }
            }
        }


    }
}